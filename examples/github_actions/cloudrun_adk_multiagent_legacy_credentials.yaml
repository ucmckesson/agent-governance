name: Build and Deploy ADK MultiAgent to Cloud Run (Legacy Credentials)

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "adk-multiagent-test/**"
      - "src/agent_governance/**"
      - "examples/github_actions/cloudrun_adk_multiagent_legacy_credentials.yaml"

env:
  PROJECT_ID: your-gcp-project-id
  GAR_NAME: app-images
  GAR_LOCATION: us-west1
  SERVICE: adk-multiagent-prod-test
  REGION: us-west1

jobs:
  deploy:
    permissions:
      contents: read
      id-token: write

    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Docker Auth
        run: gcloud auth configure-docker "${{ env.GAR_LOCATION }}-docker.pkg.dev" --quiet

      - name: Build and Push Container
        run: |
          IMAGE_URI="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_NAME }}/${{ env.SERVICE }}:${{ github.sha }}"
          docker buildx build \
            -t "$IMAGE_URI" \
            -f adk-multiagent-test/deploy/cloud_run/Dockerfile \
            .
          docker push "$IMAGE_URI"
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE }}
          region: ${{ env.REGION }}
          project_id: ${{ env.PROJECT_ID }}
          image: ${{ env.IMAGE_URI }}
          flags: >-
            --allow-unauthenticated
          env_vars: |
            GOVERNANCE_CONFIG_PATH=/app/adk-multiagent-test/deploy/cloud_run/governance.yaml
            AZURE_OPENAI_MOCK=false
            AZURE_OPENAI_ENDPOINT=${{ vars.AZURE_OPENAI_ENDPOINT }}
            AZURE_OPENAI_API_VERSION=${{ vars.AZURE_OPENAI_API_VERSION }}
            AZURE_OPENAI_DEPLOYMENT_NAME=${{ vars.AZURE_OPENAI_DEPLOYMENT_NAME }}
            AZURE_OPENAI_SCOPE=${{ vars.AZURE_OPENAI_SCOPE }}
            AZURE_OPENAI_TOKEN_URL=${{ vars.AZURE_OPENAI_TOKEN_URL }}
          secrets: |
            AZURE_OPENAI_CLIENT_ID=AZURE_OPENAI_CLIENT_ID:latest
            AZURE_OPENAI_CLIENT_SECRET=AZURE_OPENAI_CLIENT_SECRET:latest

      - name: Smoke Test
        run: |
          URL="${{ steps.deploy.outputs.url }}"
          echo "Cloud Run URL: $URL"
          curl -fsS "$URL/health"
          curl -fsS -X POST "$URL/smoke"
